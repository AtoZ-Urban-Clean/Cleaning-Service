<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Track Booking | AtoZ Urban Clean</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
:root {
    --primary: #0066ff;
    --secondary: #ff007f;
    --bg: #f6f6f6;
    --text: #333;
    --completed: #28a745;
    --pending: #ccc;
}

/* General Styles */
body {
    margin: 0;
    font-family: 'Segoe UI', Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    padding-bottom: 40px;
}

/* Header */
header {
    background: #fff;
    padding: 12px 20px;
    display: flex;
    align-items: center;
    border-bottom: 1px solid #ddd;
    position: sticky;
    top: 0;
    z-index: 1000;
}

.company-name { flex: 1; }
.company-name a { text-decoration: none; font-size: 14px; font-weight: 800; color: var(--primary); }
.page-title { flex: 2; text-align: center; font-size: 16px; font-weight: 600; color: #555; text-transform: uppercase; }
.spacer { flex: 1; text-align: right; }

/* Container */
.container {
    max-width: 500px;
    width: 100%;
    background: #fff;
    padding: 30px 25px;
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.12);
    margin: 20px auto;
    text-align: center;
}

/* Inputs and Button */
input, button {
    width: 100%;
    padding: 14px;
    margin-top: 12px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 14px;
    box-sizing: border-box;
}

input:focus {
    border-color: var(--primary);
    outline: none;
    box-shadow: 0 0 0 2px rgba(0,102,255,0.1);
}

button {
    background: var(--secondary);
    color: #fff;
    border: none;
    font-weight: bold;
    cursor: pointer;
    transition: 0.3s;
}

button:hover { background: #e60072; }

/* Progress Tracker */
.progress-container {
    display: flex;
    justify-content: space-between;
    margin-top: 30px;
    position: relative;
}

.progress-container::before {
    content: '';
    position: absolute;
    top: 22px;
    left: 10%;
    width: 80%;
    height: 4px;
    background: var(--pending);
    z-index: 0;
    border-radius: 2px;
}

.progress-step {
    z-index: 1;
    position: relative;
    width: 40px;
    height: 40px;
    background: var(--pending);
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 18px;
    color: #fff;
    transition: 0.3s;
}

.progress-step.completed {
    background: var(--completed);
}

.progress-labels {
    display: flex;
    justify-content: space-between;
    margin-top: 12px;
    font-size: 12px;
    color: #666;
}

.progress-labels div {
    width: 60px;
    text-align: center;
}

/* Result Box */
#resultBox {
    margin-top: 20px;
    font-size: 14px;
    text-align: left;
}

@media (max-width: 450px) {
    .container { padding: 25px 15px; }
    button, input { font-size: 14px; padding: 12px; }
}
</style>
</head>
<body>

<header>
    <div class="company-name"><a href="index.html">AtoZ Urban Clean</a></div>
    <div class="page-title">Track Booking</div>
    <div class="spacer"><a href="services.html" style="font-size: 12px; color: #666; text-decoration: none;"><i class="fas fa-plus"></i> Add</a></div>
</header>

<div class="container">
    <input type="text" id="trackID" placeholder="AZUC-YYYYMMDD-XXXX">
    <button onclick="track()">Track Booking</button>

    <div class="progress-container">
        <div class="progress-step" id="step1"><i class="fas fa-clock"></i></div>
        <div class="progress-step" id="step2"><i class="fas fa-check"></i></div>
        <div class="progress-step" id="step3"><i class="fas fa-user-check"></i></div>
        <div class="progress-step" id="step4"><i class="fas fa-box"></i></div>
        <div class="progress-step" id="step5"><i class="fas fa-star"></i></div>
    </div>
    <div class="progress-labels">
        <div>Waiting</div>
        <div>Confirmed</div>
        <div>Assigned</div>
        <div>Completed</div>
        <div>Review</div>
    </div>

    <div id="resultBox"></div>
</div>

<script>

const webAppUrl = "https://script.google.com/macros/s/AKfycbzunhYfvCqIR0H7ed5U2dr0YhzmEQ5ohg_AXI_g-xbhrW8Rd6i18WeJKtPWAZQ1-zY79g/exec";

const trackInput = document.getElementById("trackID");
const resultDiv = document.getElementById("resultBox");

trackInput.value = localStorage.getItem("lastBookingID") || "";

// Ask notification permission
if ("Notification" in window) {
    Notification.requestPermission();
}

async function track(){
    const id = trackInput.value.trim();
    if(!id) return alert("Enter Booking ID");

    localStorage.setItem("lastBookingID", id);

    fetchStatus(id, true);
}

async function fetchStatus(id, manual = false){

    try {
        const response = await fetch(`${webAppUrl}?action=track&id=${id}`);
        const data = await response.json();

        if(data.found){

            resultDiv.innerHTML =
            `<b>Customer:</b> ${data.name}<br>
             <b>Booking ID:</b> ${id}<br>
             <b>Status:</b> ${data.status}`;

            updateProgress(data.status);

            // ðŸ”” NOTIFICATION LOGIC
            const lastStatus = localStorage.getItem("status_"+id);

            if(lastStatus && lastStatus !== data.status){
                showNotification(data.status, id);
            }

            localStorage.setItem("status_"+id, data.status);

        } else {
            resultDiv.innerHTML = "âŒ Booking ID not found.";
        }

    } catch(error){
        console.log(error);
    }
}

function showNotification(status, id){

    if(Notification.permission === "granted"){

        const notification = new Notification("AtoZ Urban Clean", {
            body: "Booking Updated: " + status,
            icon: "atoz.png"
        });

        notification.onclick = function(){
            window.focus();
        };
    }
}

function updateProgress(status){

    const steps = [1,2,3,4,5];
    steps.forEach(n => document.getElementById('step'+n).classList.remove('completed'));

    const statusMap = {
        "waiting":1,
        "confirmed":2,
        "assigned":3,
        "completed":4,
        "review":5
    };

    const stepNum = statusMap[status.toLowerCase()] || 1;

    for(let i=1;i<=stepNum;i++){
        document.getElementById('step'+i).classList.add('completed');
    }
}

// ðŸ” AUTO CHECK EVERY 10 SECONDS
setInterval(()=>{
    const id = trackInput.value.trim();
    if(id){
        fetchStatus(id);
    }
}, 10000);

</script>


</body>
</html>
